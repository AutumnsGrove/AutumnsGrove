name: Sync Recipes to CloudFlare D1

on:
  push:
    branches:
      - main
    paths:
      - 'UserContent/Recipes/**'
  workflow_dispatch:  # Allow manual triggering

jobs:
  sync-recipes:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install gray-matter marked

    - name: Read and process recipes
      id: process-recipes
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const matter = require('gray-matter');

        // Normalize slug to kebab-case (matches worker normalization)
        function normalizeSlug(slug) {
          return slug
            .toLowerCase()
            .trim()
            .replace(/\s+/g, '-')
            .replace(/_+/g, '-')
            .replace(/[^a-z0-9-]/g, '')
            .replace(/-+/g, '-')
            .replace(/^-+|-+$/g, '');
        }

        const recipesDir = './UserContent/Recipes';
        const recipes = [];

        // Check if directory exists
        if (!fs.existsSync(recipesDir)) {
          console.log('No recipes directory found, skipping sync');
          fs.writeFileSync('recipes-data.json', JSON.stringify([]));
          fs.appendFileSync(process.env.GITHUB_OUTPUT, 'recipe-count=0\n');
          process.exit(0);
        }

        // Read all markdown files (not directories)
        const files = fs.readdirSync(recipesDir).filter(file => {
          const filePath = path.join(recipesDir, file);
          return file.endsWith('.md') && fs.statSync(filePath).isFile();
        });

        for (const file of files) {
          const filePath = path.join(recipesDir, file);
          const content = fs.readFileSync(filePath, 'utf8');

          // Generate SEO-friendly slug
          const rawSlug = file.replace('.md', '');
          const slug = normalizeSlug(rawSlug);

          if (!slug) {
            console.error(`Warning: Could not generate valid slug for file: ${file}`);
            continue;
          }

          recipes.push({
            slug,
            content,
            filePath
          });

          console.log(`Processed: ${file} -> ${slug}`);
        }

        // Write recipes to a JSON file to avoid shell escaping issues
        fs.writeFileSync('recipes-data.json', JSON.stringify(recipes));

        // Output recipe count for the next step
        fs.appendFileSync(process.env.GITHUB_OUTPUT, `recipe-count=${recipes.length}\n`);

        console.log(`Total recipes processed: ${recipes.length}`);
        EOF

    - name: Sync recipes to CloudFlare D1
      env:
        WORKER_URL: ${{ secrets.CLOUDFLARE_WORKER_URL }}
        SYNC_API_KEY: ${{ secrets.CLOUDFLARE_SYNC_API_KEY }}
      run: |
        echo "Syncing ${{ steps.process-recipes.outputs.recipe-count }} recipes to CloudFlare D1..."

        # Skip if no recipes
        if [ "${{ steps.process-recipes.outputs.recipe-count }}" -eq 0 ]; then
          echo "No recipes to sync, skipping."
          exit 0
        fi

        # Call the CloudFlare Worker sync endpoint using the JSON file
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "$WORKER_URL/sync-recipes" \
          -H "Authorization: Bearer $SYNC_API_KEY" \
          -H "Content-Type: application/json" \
          -d @recipes-data.json)

        # Extract response body and status code
        HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

        echo "Response Status: $HTTP_STATUS"
        echo "Response Body: $RESPONSE_BODY"

        # Check if the request was successful
        if [ "$HTTP_STATUS" -eq 200 ]; then
          echo "Recipes synced successfully!"

          # Parse and display results
          SYNCED=$(echo "$RESPONSE_BODY" | jq -r '.synced // 0')
          ERRORS=$(echo "$RESPONSE_BODY" | jq -r '.errors // []')

          echo "Recipes synced: $SYNCED"

          if [ "$(echo "$ERRORS" | jq 'length')" -gt 0 ]; then
            echo "Some recipes had errors:"
            echo "$ERRORS" | jq -r '.[] | "  - \(.slug): \(.error)"'
            exit 1
          fi
        else
          echo "Failed to sync recipes"
          echo "Error: $RESPONSE_BODY"
          exit 1
        fi

    - name: Update sync status
      if: success()
      run: |
        echo "All recipes have been successfully synced to CloudFlare D1 database!"
        echo "Sync Summary:"
        echo "  - Total recipes processed: ${{ steps.process-recipes.outputs.recipe-count }}"
        echo "  - Sync completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

    - name: Handle sync failure
      if: failure()
      run: |
        echo "Recipe sync failed!"
        echo "Please check the logs above for details."
        echo "You can also manually trigger the sync from the Actions tab."
