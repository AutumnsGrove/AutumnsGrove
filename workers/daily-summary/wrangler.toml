name = "autumnsgrove-daily-summary"
main = "index.js"
compatibility_date = "2025-01-01"

# D1 Database binding (same as main site)
[[d1_databases]]
binding = "DB"
database_name = "autumnsgrove-git-stats"
database_id = "0ca4036f-93f7-4c8a-98a5-5353263acd44"

# Workers AI binding (no API key needed!)
[ai]
binding = "AI"

# Queue for background job processing
[[queues.producers]]
queue = "daily-summary-jobs"
binding = "JOBS_QUEUE"

[[queues.consumers]]
queue = "daily-summary-jobs"
max_batch_size = 1
max_batch_timeout = 30
max_retries = 2

# Environment variables
[vars]
GITHUB_USERNAME = "AutumnsGrove"
OWNER_NAME = "Autumn"
TIMEZONE = "America/New_York"
GITHUB_API_URL = "https://api.github.com/graphql"
ALLOWED_ORIGIN = "https://autumnsgrove.com"

# Run at 11:59 PM Eastern Time daily
# Cron is in UTC: 11:59 PM ET = 4:59 AM UTC (EST) or 3:59 AM UTC (EDT)
# Using 4:59 AM UTC for EST (winter), adjust for DST manually if needed
[triggers]
crons = ["59 4 * * *"]

# Production environment
[env.production.vars]
ENVIRONMENT = "production"
ALLOWED_ORIGIN = "https://autumnsgrove.com"

[[env.production.d1_databases]]
binding = "DB"
database_name = "autumnsgrove-git-stats"
database_id = "0ca4036f-93f7-4c8a-98a5-5353263acd44"

[env.production.ai]
binding = "AI"

[[env.production.queues.producers]]
queue = "daily-summary-jobs"
binding = "JOBS_QUEUE"

[[env.production.queues.consumers]]
queue = "daily-summary-jobs"
max_batch_size = 1
max_batch_timeout = 30
max_retries = 2

[env.production.triggers]
crons = ["59 4 * * *"]

# Secrets (set using: wrangler secret put <SECRET_NAME>)
# GITHUB_TOKEN - GitHub Personal Access Token with repo scope
# ANTHROPIC_API_KEY - Anthropic API key for Claude models (required for default provider)
# MOONSHOT_API_KEY - Moonshot AI API key for Kimi K2 (optional, future use)

# Optional: Override default AI model via environment variable
# AI_MODEL = "anthropic:claude-haiku-4-5-20250514"  # Default
# AI_MODEL = "cloudflare:@cf/meta/llama-3.1-70b-instruct"  # Use Cloudflare instead
